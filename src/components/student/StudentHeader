import React, { useState, useEffect, useRef } from "react";
import { Link } from "react-router-dom";
import styled from "styled-components";
import { ReactComponent as SearchIcon } from "./SearchIcon.svg"; // путь к иконке поиска

interface StudentHeaderProps {
  title: string;
  backTo?: string;
  children?: React.ReactNode;
}

export const StudentHeader: React.FC<StudentHeaderProps> = ({ title, backTo, children }) => {
  const [searchOpen, setSearchOpen] = useState(false);

  const isTestsHeader = title.trim().toLowerCase() === "тестирования";
  const hideUser = title.trim().toLowerCase() === "профиль";

  const closeSearch = () => setSearchOpen(false);

  return (
    <Header>
      <Left>
        {backTo && (
          <BackLink to={backTo} aria-label="Назад">
            <ArrowIcon />
          </BackLink>
        )}
        <Title>{title}</Title>
      </Left>

      <Right>
        {isTestsHeader && (
          <>
            {searchOpen ? (
              <SearchInput onClose={closeSearch} />
            ) : (
              <SearchButton onClick={() => setSearchOpen(true)} />
            )}
          </>
        )}

        {!hideUser && (
          <User>
            <Avatar
              src="https://i.pravatar.cc/60?img=5"
              alt="User avatar"
              width={36}
              height={36}
            />
            <Info>
              <Name>Диана Фильченко</Name>
              <Nick>@d_filchenko</Nick>
            </Info>
          </User>
        )}
      </Right>

      {children}
    </Header>
  );
};

// --- Компоненты поиска ---

const SearchButton = ({ onClick }: { onClick: () => void }) => (
  <IconBtn onClick={onClick} aria-label="Поиск" title="Открыть поиск" type="button">
    <SearchIcon />
  </IconBtn>
);

const SearchInput = ({ onClose }: { onClose: () => void }) => {
  const inputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    inputRef.current?.focus();

    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        onClose();
      }
    };

    inputRef.current?.addEventListener("keydown", handleKeyDown);
    return () => {
      inputRef.current?.removeEventListener("keydown", handleKeyDown);
    };
  }, [onClose]);

  return (
    <Input
      ref={inputRef}
      type="text"
      placeholder="Поиск тестов…"
      aria-label="Строка поиска по тестам"
      onBlur={onClose}
    />
  );
};

// --- Стили ---

const Header = styled.header`
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #d0d7de;
  padding: 0 20px 12px;
  margin-bottom: 24px;
  min-height: 56px;
  box-sizing: border-box;
`;

const Left = styled.div`
  display: flex;
  align-items: center;
  gap: 10px;
`;

const Right = styled.div`
  display: flex;
  align-items: center;
  gap: 15px;
`;

const BackLink = styled(Link)`
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: #f4f9ff;
  color: #0e73f6;
  display: grid;
  place-items: center;
  text-decoration: none;
  font-size: 20px;
`;

const Title = styled.h1`
  font-size: 20px;
  font-weight: 600;
  margin: 0;
`;

const IconBtn = styled.button`
  background: none;
  border: none;
  padding: 6px;
  cursor: pointer;
  color: #0e73f6;
`;

const Input = styled.input`
  padding: 6px 8px;
  font-size: 16px;
`;

const User = styled.div`
  display: flex;
  align-items: center;
  gap: 10px;
`;

const Avatar = styled.img`
  border-radius: 50%;
  width: 36px;
  height: 36px;
  object-fit: cover;
`;

const Info = styled.div`
  display: flex;
  flex-direction: column;
`;

const Name = styled.span`
  font-weight: 600;
`;

const Nick = styled.span`
  font-size: 12px;
  color: #666;
`;

const ArrowIcon = () => (
  <svg
    width="16"
    height="16"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    viewBox="0 0 24 24"
    aria-hidden="true"
  >
    <path d="M15 18l-6-6 6-6" />
  </svg>
);
